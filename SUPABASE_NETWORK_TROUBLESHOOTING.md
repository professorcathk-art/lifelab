# Supabase 网络连接问题排查指南

## 问题描述

应用在尝试同步数据到 Supabase 时遇到网络连接错误：
- 错误代码：`-1005` (NSURLErrorNetworkConnectionLost)
- 错误信息：`The network connection was lost`
- 重试：已尝试 3 次，均失败

## 当前状态

✅ **好消息**：
- 数据已经保存到本地缓存
- 应用可以继续使用本地数据
- 网络恢复后会自动重试同步

❌ **问题**：
- 无法连接到 Supabase 服务器
- 数据无法同步到云端

## 可能的原因

### 1. 网络连接不稳定
- WiFi 信号弱
- 移动网络不稳定
- 网络切换（WiFi ↔ 移动网络）

### 2. Supabase 服务器问题
- Supabase 服务暂时不可用
- 服务器维护中
- 区域网络限制

### 3. 防火墙/代理问题
- 公司/学校防火墙阻止连接
- VPN 配置问题
- 代理服务器设置

### 4. DNS 解析问题
- DNS 服务器无法解析 Supabase 域名
- DNS 缓存问题

## 解决方案

### 方案 1：检查网络连接（最简单）

1. **检查设备网络**
   - 确保设备连接到互联网
   - 尝试打开其他网站或应用
   - 切换网络（WiFi ↔ 移动网络）

2. **测试 Supabase 连接**
   - 在浏览器中访问：https://inlzhosqbccyynofbmjt.supabase.co
   - 如果无法访问，可能是网络问题

### 方案 2：检查 Supabase 服务状态

1. **访问 Supabase Status Page**
   - https://status.supabase.com
   - 检查是否有服务中断

2. **检查项目状态**
   - 登录 Supabase Dashboard
   - 检查项目是否正常运行
   - 查看项目日志

### 方案 3：网络诊断

在应用中添加网络诊断功能（已实现）：

```swift
// 检查网络状态
print("📡 Network status: \(isOnline ? "Online" : "Offline")")
print("📡 Network type: WiFi/Cellular")
```

### 方案 4：增加重试和超时（已实现）

代码已经实现了：
- ✅ 3 次重试
- ✅ 指数退避（3s, 6s, 12s）
- ✅ 90 秒请求超时
- ✅ 180 秒资源超时
- ✅ 自动网络监控

### 方案 5：手动触发同步

如果网络恢复，可以手动触发同步：

1. **重启应用**
   - 应用启动时会自动尝试同步

2. **触发数据更新**
   - 修改任何数据
   - 应用会自动尝试同步

## 当前代码行为

### 网络错误处理流程

```
尝试同步到 Supabase
  ↓
网络错误 (-1005)
  ↓
保存数据到本地 ✅
  ↓
重试 1/3 (等待 3 秒)
  ↓
重试 2/3 (等待 6 秒)
  ↓
重试 3/3 (等待 12 秒)
  ↓
所有重试失败
  ↓
数据保留在本地 ✅
  ↓
网络监控检测到网络恢复
  ↓
自动触发同步 ✅
```

### 数据安全

✅ **数据不会丢失**：
- 所有数据都保存在本地 UserDefaults
- 即使网络失败，数据仍然可用
- 网络恢复后会自动同步

## 测试步骤

### 1. 测试网络连接

```bash
# 在终端中测试 Supabase 连接
curl -I https://inlzhosqbccyynofbmjt.supabase.co
```

如果返回 `200 OK`，说明网络连接正常。

### 2. 测试 Supabase API

```bash
# 测试 REST API
curl -X GET \
  "https://inlzhosqbccyynofbmjt.supabase.co/rest/v1/user_profiles" \
  -H "apikey: YOUR_ANON_KEY" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### 3. 检查应用日志

查看 Xcode 控制台中的日志：
- `📡 Network status`: 网络状态
- `🔄 Attempt X/3`: 重试次数
- `❌❌❌ REQUEST FAILED`: 最终失败
- `💾 Data saved locally`: 数据已保存

## 常见问题

### Q: 为什么数据没有同步？
A: 网络连接失败。数据已保存在本地，网络恢复后会自动同步。

### Q: 数据会丢失吗？
A: 不会。所有数据都保存在本地，即使网络失败也不会丢失。

### Q: 如何手动触发同步？
A: 修改任何数据，应用会自动尝试同步。或者重启应用。

### Q: 网络恢复后会自动同步吗？
A: 是的。网络监控会检测到网络恢复，并自动触发同步。

### Q: 可以增加重试次数吗？
A: 可以，但需要权衡用户体验。当前 3 次重试已经足够，增加重试次数可能会让用户等待更久。

## 改进建议

### 1. 添加网络状态指示器
在 UI 中显示网络状态，让用户知道数据是否已同步。

### 2. 添加手动同步按钮
允许用户手动触发同步，而不是等待自动同步。

### 3. 显示同步状态
在设置页面显示：
- 最后同步时间
- 同步状态（成功/失败/进行中）
- 待同步的数据量

### 4. 离线模式提示
当网络不可用时，显示提示信息，告知用户数据已保存，将在网络恢复后同步。

## 总结

✅ **当前状态**：
- 数据已保存到本地
- 应用可以正常使用
- 网络恢复后会自动同步

⚠️ **需要关注**：
- 网络连接稳定性
- Supabase 服务状态
- 防火墙/代理设置

💡 **建议**：
- 检查网络连接
- 确认 Supabase 服务正常
- 等待网络恢复后自动同步
